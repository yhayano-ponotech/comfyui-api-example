## ComfyUI Prompt Server API リファレンス (詳細版)

このドキュメントは、ComfyUI Prompt Server の API リファレンスを詳細に提供します。

### WebSocket

**エンドポイント:** `/ws`

**メソッド:** GET

**説明:** WebSocket 接続を確立します。クライアントとサーバー間の双方向通信に使用され、リアルタイムな更新や通知を可能にします。

**クエリパラメータ:**

- `clientId`: 
    - 既存のセッションを再利用するためのクライアントID。
    - クライアントが再接続する場合、以前のセッションを維持するために同じ `clientId` を使用できます。
    - 指定しない場合、新しい `clientId` が生成されます。

**イベント:**

- `status`: 
    - キューの状態に関する情報を送信します。
    - データには、実行中のタスク数、キュー内のタスク数、実行中のプロンプトのIDなどが含まれます。
    - クライアントが接続したとき、およびキューの状態が変化したときに送信されます。
- `executing`: 
    - 現在実行中のノードに関する情報を送信します。
    - データには、実行中のノードのID、ノードの名前などが含まれます。
    - 新しいノードの実行が開始されたときに送信されます。
- `download_progress`: 
    - モデルダウンロードの進捗状況に関する情報を送信します。
    - データには、ダウンロード中のファイル名、ダウンロードの進捗状況 (パーセンテージ)、ダウンロード速度などが含まれます。
    - モデルのダウンロード中に定期的に送信されます。
- `BinaryEventTypes.PREVIEW_IMAGE`: 
    - プレビュー画像のバイナリデータを送信します。
    - データには、画像のタイプ (JPEG/PNG)、画像のバイナリデータ、画像の最大サイズなどが含まれます。
    - ノードがプレビュー画像を生成したときに送信されます。
- `BinaryEventTypes.UNENCODED_PREVIEW_IMAGE`: 
    - エンコードされていないプレビュー画像のバイナリデータを送信します。
    - データには、画像のタイプ (JPEG/PNG)、画像のバイナリデータなどが含まれます。
    - ノードがエンコードされていないプレビュー画像を生成したときに送信されます。
    - このイベントは、クライアント側でエンコード処理を行う必要がある場合に使用されます。

### HTTPエンドポイント

**`/`**

**メソッド:** GET

**説明:** フロントエンドの index.html を返します。ComfyUI のユーザーインターフェースを表示するために使用されます。

**`/embeddings`**

**メソッド:** GET

**説明:** 使用可能な埋め込みのリストを返します。埋め込みは、テキストをベクトル表現に変換するために使用されます。

**レスポンス:**

```json
[
  "embedding1",
  "embedding2",
  ...
]
```

**`/models/{folder}`**

**メソッド:** GET

**説明:** 指定されたフォルダ内のモデルのリストを返します。モデルは、画像生成などのタスクを実行するために使用されます。

**パラメータ:**

- `{folder}`: モデルが保存されているフォルダの名前。

**レスポンス:**

```json
[
  "model1.ckpt",
  "model2.safetensors",
  ...
]
```

**`/extensions`**

**メソッド:** GET

**説明:** 使用可能な拡張機能のリストを返します。拡張機能は、ComfyUI の機能を拡張するために使用されます。

**レスポンス:**

```json
[
  "/extensions/extension1.js",
  "/extensions/extension2.js",
  ...
]
```

**`/upload/image`**

**メソッド:** POST

**説明:** 画像をアップロードします。アップロードされた画像は、入力として使用したり、マスクとして使用したりできます。

**リクエストボディ:**

- `image`: 
    - アップロードする画像ファイル。
    - `multipart/form-data` 形式で送信する必要があります。
- `overwrite`: 
    - 既存のファイルを上書きするかどうか。
    - `true` または `false` を指定します。
    - 指定しない場合、デフォルトは `false` です。
- `type`: 
    - 画像のアップロード先の種類。
    - `input`, `temp`, `output` のいずれかを指定します。
    - 指定しない場合、デフォルトは `input` です。
- `subfolder`: 
    - 画像を保存するサブフォルダ。
    - 指定しない場合、ルートフォルダに保存されます。

**レスポンス:**

```json
{
  "name": "アップロードされたファイル名",
  "subfolder": "画像が保存されたサブフォルダ",
  "type": "画像のアップロード先の種類"
}
```

**`/upload/mask`**

**メソッド:** POST

**説明:** マスク画像をアップロードします。マスク画像は、画像の特定の領域を編集するために使用されます。

**リクエストボディ:**

- `image`: 
    - アップロードするマスク画像ファイル。
    - `multipart/form-data` 形式で送信する必要があります。
- `overwrite`: 
    - 既存のファイルを上書きするかどうか。
    - `true` または `false` を指定します。
    - 指定しない場合、デフォルトは `false` です。
- `original_ref`: 
    - マスクが適用される元の画像の情報。
    - `filename`, `subfolder`, `type` などの情報を含みます。
- `type`: 
    - 画像のアップロード先の種類。
    - `input`, `temp`, `output` のいずれかを指定します。
    - 指定しない場合、デフォルトは `output` です。
- `subfolder`: 
    - 画像を保存するサブフォルダ。
    - 指定しない場合、ルートフォルダに保存されます。

**レスポンス:**

```json
{
  "name": "アップロードされたファイル名",
  "subfolder": "画像が保存されたサブフォルダ",
  "type": "画像のアップロード先の種類"
}
```

**`/view`**

**メソッド:** GET

**説明:** 画像を表示します。画像のプレビューを表示したり、画像をダウンロードしたりするために使用されます。

**クエリパラメータ:**

- `filename`: 
    - 表示する画像のファイル名。
- `type`: 
    - 画像の種類。
    - `input`, `temp`, `output` のいずれかを指定します。
    - 指定しない場合、デフォルトは `output` です。
- `subfolder`: 
    - 画像が保存されているサブフォルダ。
    - 指定しない場合、ルートフォルダが検索されます。
- `preview`: 
    - プレビュー画像を生成するかどうか。
    - `webp` または `jpeg` を指定します。
    - 指定しない場合、元の画像が表示されます。
- `channel`: 
    - 表示するチャンネル。
    - `rgb`, `a`, `rgba` のいずれかを指定します。
    - 指定しない場合、デフォルトは `rgba` です。

**`/view_metadata/{folder_name}`**

**メソッド:** GET

**説明:** safetensors ファイルのメタデータを表示します。メタデータには、モデルの作成者、モデルの説明、モデルのライセンスなどの情報が含まれています。

**パラメータ:**

- `{folder_name}`: safetensors ファイルが保存されているフォルダの名前。

**クエリパラメータ:**

- `filename`: メタデータを表示する safetensors ファイル名。

**レスポンス:**

```json
{
  "author": "モデルの作成者",
  "description": "モデルの説明",
  "license": "モデルのライセンス",
  ...
}
```

**`/system_stats`**

**メソッド:** GET

**説明:** システム統計情報を返します。システムの CPU 使用率、メモリ使用量、GPU 使用量などの情報が含まれています。

**レスポンス:**

```json
{
  "system": {
    "os": "オペレーティングシステムの名前",
    "comfyui_version": "ComfyUI のバージョン",
    "python_version": "Python のバージョン",
    "pytorch_version": "PyTorch のバージョン",
    "embedded_python": "Python が埋め込み版かどうか",
    "argv": "コマンドライン引数"
  },
  "devices": [
    {
      "name": "デバイスの名前",
      "type": "デバイスの種類",
      "index": "デバイスのインデックス",
      "vram_total": "VRAM の合計容量",
      "vram_free": "VRAM の空き容量",
      "torch_vram_total": "PyTorch が認識している VRAM の合計容量",
      "torch_vram_free": "PyTorch が認識している VRAM の空き容量"
    },
    ...
  ]
}
```

**`/prompt`**

**メソッド:** GET

**説明:** キューの状態に関する情報を返します。実行中のタスク数、キュー内のタスク数、実行中のプロンプトのIDなどが含まれます。

**レスポンス:**

```json
{
  "exec_info": {
    "queue_remaining": "キュー内のタスク数"
  }
}
```

**`/prompt`**

**メソッド:** POST

**説明:** プロンプトをキューに追加します。プロンプトは、ComfyUI で実行される一連のノードを表します。

**リクエストボディ:**

- `number`: 
    - プロンプトの番号。
    - プロンプトの実行順序を制御するために使用されます。
- `prompt`: 
    - 実行するプロンプト。
    - JSON 形式でノードとその接続を表します。
- `extra_data`: 
    - プロンプトに追加する追加データ。
    - クライアント固有の情報などを渡すために使用できます。
- `client_id`: 
    - プロンプトを送信したクライアントのID。
    - プロンプトの実行結果を特定のクライアントに送信するために使用されます。

**レスポンス:**

```json
{
  "prompt_id": "プロンプトのID",
  "number": "プロンプトの番号",
  "node_errors": "プロンプトの検証中に発生したエラー"
}
```

**`/queue`**

**メソッド:** GET

**説明:** キューの状態に関する情報を返します。実行中のタスク数、キュー内のタスク数などが含まれます。

**レスポンス:**

```json
{
  "queue_running": "実行中のタスク数",
  "queue_pending": "キュー内のタスク数"
}
```

**`/queue`**

**メソッド:** POST

**説明:** キューを操作します。キューをクリアしたり、キュー内の特定のプロンプトを削除したりできます。

**リクエストボディ:**

- `clear`: 
    - キューをクリアするかどうか。
    - `true` または `false` を指定します。
- `delete`: 
    - 削除するプロンプトのIDのリスト。

**`/interrupt`**

**メソッド:** POST

**説明:** 現在実行中の処理を中断します。実行中のプロンプトが途中で停止されます。

**`/free`**

**メソッド:** POST

**説明:** メモリを解放します。使用されていないモデルをアンロードしたり、キャッシュをクリアしたりできます。

**リクエストボディ:**

- `unload_models`: 
    - モデルをアンロードするかどうか。
    - `true` または `false` を指定します。
- `free_memory`: 
    - メモリを解放するかどうか。
    - `true` または `false` を指定します。

**`/history`**

**メソッド:** GET

**説明:** プロンプトの履歴を返します。過去に実行されたプロンプトの情報が保存されています。

**クエリパラメータ:**

- `max_items`: 
    - 返す履歴の最大数。
    - 指定しない場合、全ての履歴が返されます。

**レスポンス:**

```json
[
  {
    "prompt_id": "プロンプトのID",
    "number": "プロンプトの番号",
    "prompt": "実行されたプロンプト",
    "timestamp": "プロンプトの実行日時",
    ...
  },
  ...
]
```

**`/history/{prompt_id}`**

**メソッド:** GET

**説明:** 指定されたIDのプロンプトの履歴を返します。

**パラメータ:**

- `{prompt_id}`: 取得するプロンプトのID。

**レスポンス:**

```json
{
  "prompt_id": "プロンプトのID",
  "number": "プロンプトの番号",
  "prompt": "実行されたプロンプト",
  "timestamp": "プロンプトの実行日時",
  ...
}
```

**`/history`**

**メソッド:** POST

**説明:** プロンプトの履歴を操作します。履歴をクリアしたり、履歴内の特定のプロンプトを削除したりできます。

**リクエストボディ:**

- `clear`: 
    - 履歴をクリアするかどうか。
    - `true` または `false` を指定します。
- `delete`: 
    - 削除するプロンプトのIDのリスト。

**`/internal/models/download`**

**メソッド:** POST

**説明:** 指定された URL からモデルをダウンロードします。モデルは、画像生成などのタスクを実行するために使用されます。

**リクエストボディ:**

- `url`: 
    - ダウンロードするモデルの URL。
- `model_directory`: 
    - モデルを保存するディレクトリ。
- `model_filename`: 
    - モデルのファイル名。
- `progress_interval`: 
    - ダウンロードの進捗状況を報告する間隔 (秒)。

**レスポンス:**

```json
{
  "status": "ダウンロードの状態 (success/error)",
  "message": "エラーメッセージ (エラーの場合)",
  "download_path": "ダウンロードされたモデルのパス"
}
```

**`/object_info`**

**メソッド:** GET

**説明:** 全てのノードの情報 (入力、出力、説明など) を返します。ノードは、ComfyUI の基本的な構成要素であり、画像処理などのタスクを実行します。

**レスポンス:**

```json
{
  "NodeClassName1": {
    "input": "ノードの入力タイプ",
    "input_order": "ノードの入力の順序",
    "output": "ノードの出力タイプ",
    "output_is_list": "ノードの出力がリストかどうか",
    "output_name": "ノードの出力の名前",
    "name": "ノードの名前",
    "display_name": "ノードの表示名",
    "description": "ノードの説明",
    "python_module": "ノードの Python モジュール",
    "category": "ノードのカテゴリ",
    "output_node": "ノードが出力ノードかどうか",
    "deprecated": "ノードが非推奨かどうか",
    "experimental": "ノードが実験的かどうか"
  },
  "NodeClassName2": {
    ...
  },
  ...
}
```

**`/object_info/{node_class}`**

**メソッド:** GET

**説明:** 指定されたノードクラスの情報 (入力、出力、説明など) を返します。

**パラメータ:**

- `{node_class}`: 情報を取得するノードクラスの名前。

**レスポンス:**

```json
{
  "NodeClassName": {
    "input": "ノードの入力タイプ",
    "input_order": "ノードの入力の順序",
    "output": "ノードの出力タイプ",
    "output_is_list": "ノードの出力がリストかどうか",
    "output_name": "ノードの出力の名前",
    "name": "ノードの名前",
    "display_name": "ノードの表示名",
    "description": "ノードの説明",
    "python_module": "ノードの Python モジュール",
    "category": "ノードのカテゴリ",
    "output_node": "ノードが出力ノードかどうか",
    "deprecated": "ノードが非推奨かどうか",
    "experimental": "ノードが実験的かどうか"
  }
}
```

### エラーレスポンス

エラーが発生した場合、API は次の形式の JSON レスポンスを返します。

```json
{
  "error": "エラーメッセージ",
  "node_errors": [] 
}
```

- `error`: エラーメッセージ。エラーの原因を説明します。
- `node_errors`: プロンプトの検証中にノードでエラーが発生した場合にのみ存在します。各ノードのエラーメッセージのリストが含まれます。

**注:** この API リファレンスは、ComfyUI Prompt Server のバージョン 0.0.15 に基づいています。API は将来のバージョンで変更される可能性があります.